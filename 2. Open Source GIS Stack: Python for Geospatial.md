
## Open Source GIS Stack: Python for Geospatial

Source: **Learning the Open Source GIS Stack: Python for Geospatial** course by Arthur Lembo - udemy cource

We learn about the **FOSS4G** (Free and Open Source Software for Geospatial) stack. The course has 3 parts (excluding the Python review part):
+ Loading software and data
+ Python packages
+  Geospatial additions to Python

### Software installation:

+ **QGIS (Quantum GIS)** is a free and open-source GIS software that allows users to view, edit, and analyze geospatial data. It is designed to provide a user-friendly interface for creating, visualizing, and publishing geospatial information. QGIS can be used for a variety of tasks, such as creating and editing maps, analyzing and manipulating data, and publishing maps and data on the web. QGIS is compatible with a wide range of data formats, including shapefiles, GeoTIFF, KML, and PostGIS. It also supports a range of geospatial operations, such as geocoding, geoprocessing, and spatial analysis. QGIS is a popular choice among researchers, GIS professionals, and other users who need to work with geospatial data. 

link to download: https://www.qgis.org/en/site/forusers/download.html
+ **PostgreSQL**

As  a database management system (DBMS), we use PostgreSQL. 

PostgreSQL and MySQL have many similarities, but they also have some differences in terms of features, performance, and the way they handle certain tasks. For example, PostgreSQL has more advanced features for handling complex data types, concurrency control, and transactions, while MySQL is known for its performance and ease of use.

link to download: https://www.enterprisedb.com/downloads/postgres-postgresql-downloads

**Note on pg_qgs.qgz file (QGIS Project file)**:

The QGIS Project file named "pg_qgs.qgz"which was discussed in the course was missing in the course material. And so I created it through connecting to my PostgreSQL:

To create a QGIS project file that connects to your PostgreSQL database, you can follow these steps:

+ Open QGIS and click on "New Project" to create a new project.

+ In the "Create a new project" window, give your project a name and choose a location to save it.

+ In the "Data Source Manager" window, click on "PostgreSQL" in the left-hand panel to add a new connection to your PostgreSQL database.

+ In the "Create a new PostGIS connection" window, enter the connection details for your PostgreSQL database, including the host, port, database name, and authentication credentials.

+ Once you have entered the connection details, click on "Test Connection" to make sure that the connection is successful. If the connection is successful, click on "OK" to save the connection.

+ In the "Data Source Manager" window, expand the "PostgreSQL" connection to see the list of available tables and views in your database.

+ To add a table or view to your QGIS project, simply drag and drop it from the "Data Source Manager" window into the QGIS canvas.

+ Once you have added all the layers you want to your project, you can save the project by clicking on "Project" in the top menu bar and selecting "Save" or "Save As".

To open the project in QGIS again, simply double-click on the project file (.qgs) or open QGIS and click on "Open Project" in the start menu.


### Useful functions in PostgreSQL's PostGIS extension

+ **ST_TRANSFORM**: is a spatial function in PostgreSQL's PostGIS extension, which is used to transform the spatial reference system (SRS) of a geometry or geography object. 

    SELECT ST_TRANSFORM(geom,4326) AS geom
    FROM firestations

+ **ST_DISTANCE**: is a function in the PostGIS extension for PostgreSQL that calculates the distance between two geometric objects in a specified spatial reference system (SRS).

### SQLITE

Some simple practice:

        import sqlite3
        import os

        os.chdir("C:/Program Files/QGIS 3.30.2/bin")
        path = 'D:/0_Machine_Learning/Software -- ML Journey/17. Learning the Open Source GIS Stack Python for Gepspatial/python/'
        conn = sqlite3.Connection(path + 'tompkins.sqlite')
        answer = conn.execute('SELECT parcelkey, asmt FROM parcels LIMIT 3')
        for row in answer:
            print (row)

So through the above query I can get the parcel keys and the corresponding assessment values for the first three records:

        ('50070005900000070030000000', 160000.0)
        ('50070005900000070020000000', 260000.0)
        ('50070005700000010020010000', 190000.0)

As another example: 

        import sqlite3
        import os 

        os.chdir("C:/Program Files/QGIS 3.30.2/bin")
        path = 'D:/0_Machine_Learning/Software -- ML Journey/17. Learning the Open Source GIS Stack Python for Gepspatial/python/'
        conn = sqlite3.Connection(path + 'tompkins.sqlite')
        answer = conn.execute(f"SELECT  propclass, AVG(asmt) AS sumasmt FROM parcels GROUP BY propclass ORDER BY sumasmt ")
        for row in answer: 
            print (f"The average assessment for the property class {row[0]} is $ {row[1]:.2f}")

Which gives me the average assessment for each property class:

        The average assessment for the property class Vacant is $ 68937.44
        The average assessment for the property class   is $ 116666.67
        The average assessment for the property class Forest is $ 125865.74
        The average assessment for the property class Residential is $ 221603.24
        The average assessment for the property class Agriculture is $ 405663.41
        The average assessment for the property class Recreation is $ 922301.08
        The average assessment for the property class Commercial is $ 963517.88
        The average assessment for the property class Public Services is $ 1509577.66
        The average assessment for the property class Industrial is $ 1747535.51
        The average assessment for the property class Community Srvcs is $ 18435283.21

### Spatialite

Spatialite is a spatial extension for SQLite, which is a lightweight, serverless, open-source database management system. Spatialite adds support for spatial data types, spatial indexing, and spatial functions to SQLite, making it a powerful tool for managing and analyzing spatial data. Just like Postgres has PostGSI, SQL Server has SQL Server Spatial, and Oracle has Oracle Spatial, SQLite has Spatialite. 

To activate the Spatial part of SQLite, I need to load extension. So I can execute Spatial functions like ST_Intersects:

        import sqlite3
        import os 

        os.chdir("C:/Program Files/QGIS 3.30.2/bin")
        path = 'D:/0_Machine_Learning/Software -- ML Journey/17. Learning the Open Source GIS Stack Python for Gepspatial/python/'
        conn = sqlite3.Connection(path + 'tompkins.sqlite')
        conn.enable_load_extension(True) 
        conn.execute('SELECT load_extension("mod_spatialite")')
        answer = conn.execute("""
                        SELECT propclass, SUM(asmt) AS sumasmt
                        FROM parcels, floodzones
                        WHERE ST_INTERSECTS(parcels.geometry, floodzones.geom) AND floodzones.zone ='A'
                        GROUP BY propclass
                        ORDER BY sumasmt
        """)
        for row in answer:
            print (f"Property class {row[0]} has sum of assessment of $ {row[1]}")

which gives me back:

        Property class Industrial has sum of assessment of $ 1379700.0
        Property class Recreation has sum of assessment of $ 1732300.0
        Property class Forest has sum of assessment of $ 10067200.0
        Property class Vacant has sum of assessment of $ 23111320.0
        Property class Commercial has sum of assessment of $ 47901100.0
        Property class Agriculture has sum of assessment of $ 60125100.0
        Property class Public Services has sum of assessment of $ 96326812.0
        Property class Residential has sum of assessment of $ 160711600.0
        Property class Community Srvcs has sum of assessment of $ 6988285900.0

Another example using one of the Spatial functions (ST_DISTANCE) of Spatialite to find the minimum distance of a parcel from the flood zone:

        import sqlite3
        import os 

        os.chdir("C:/Program Files/QGIS 3.30.2/bin")
        path = 'D:/0_Machine_Learning/Software -- ML Journey/17. Learning the Open Source GIS Stack Python for Gepspatial/python/'
        conn = sqlite3.Connection(path + 'tompkins.sqlite')
        conn.enable_load_extension(True) 
        conn.execute('SELECT load_extension("mod_spatialite")')
        pkey = input('Enter your parcel key: ')
        answer = conn.execute("""   SELECT MIN(ST_DISTANCE(parcels.geometry, floodzones.geom)) AS dist
                                    FROM parcels, floodzones 
                                    WHERE parcels.parcelkey =""" + '\'' + pkey + '\'')
        for row in answer:
            if row [0]== 0:
                print ('parcel intersects the flood zone')
            else:
                print (row[0])

this query return me back (with parcel key of 50308902300000010340000000:

        1626.3723158804592

